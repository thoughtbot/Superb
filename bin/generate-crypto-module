#!/bin/sh

set -e

check_env() {
  if [ -z "$(printenv "$1")" ]; then
    echo_err "Expected '$1' to be set"
    exit 1
  fi
}

echo_err() {
  echo >&2 "$0: $*"
}

check_env PLATFORM_NAME
check_env SDKROOT

if [ -z "$1" ]; then
  echo_err "Please specify a folder in which to generate the module map."
  exit 1
fi

module_container_dir="$1"
generated_module_dir="$module_container_dir"/include/"$PLATFORM_NAME"/CommonCrypto
sdk_umbrella_dir="$SDKROOT"/usr/include/CommonCrypto

mkdir -p "$generated_module_dir"
cat > "$generated_module_dir"/module.modulemap <<EOF
module CommonCrypto [system] {
  umbrella "$sdk_umbrella_dir"
  module * { export * }
}
EOF
